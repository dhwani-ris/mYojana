[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Beneficiary Profiling",
  "enabled": 1,
  "modified": "2024-05-20 07:39:22.359728",
  "module": "myojana",
  "name": "Scheme and Followup Validate",
  "script": "frappe.ui.form.on('Beneficiary Profiling', {\n\tbefore_save(frm) {\n\t\t// your code here\n\t\t if (frm?.selected_doc?.scheme_table) {\n      for (support_items of frm?.selected_doc?.scheme_table) {\n        if (support_items.application_submitted == \"No\") {\n          if (support_items.status != 'Closed') {\n            support_items.status = 'Open'\n          }\n        } else if (support_items.application_submitted == \"Yes\") {\n          if (support_items.status != 'Closed') {\n            support_items.status = 'Under process'\n          }\n        } else if (support_items.application_submitted == \"Previously availed\") {\n          support_items.status = 'Availed'\n        } else if (support_items.application_submitted == \"Completed\") {\n          support_items.status = 'Completed'\n        }\n      }\n    }\n    // follow up status manage\n    if (frm?.selected_doc?.follow_up_table) {\n      // console.log(\"frm.selected_doc.follow_up_table\", frm.selected_doc.follow_up_table)\n      for (support_item of frm.selected_doc?.scheme_table) {\n        if (!['Completed', 'Previously availed'].includes(support_item.status)) {\n          let followups = frm.selected_doc.follow_up_table.filter(f => f.parent_ref == support_item?.name)\n          let latestFollowup = followups.length ? followups[(followups.length - 1)] : null\n          if (latestFollowup?.parent_ref == support_item.name) {\n            switch (latestFollowup.follow_up_status) {\n              case \"Interested\":\n                support_item.status = \"Open\"\n                support_item.remarks = latestFollowup.remarks || support_item.remarks\n                break;\n              case \"Not interested\":\n                support_item.status = \"Closed\"\n                support_item.remarks = latestFollowup.remarks || support_item.remarks\n                break;\n              case \"Rejected\":\n                support_item.status = \"Rejected\"\n                support_item.date_of_rejection = latestFollowup.date_of_rejection || support_item.date_of_rejection\n                support_item.reason_of_rejection = latestFollowup.reason_of_rejection || support_item.reason_of_rejection\n                support_item.remarks = latestFollowup.remarks || support_item.remarks\n                break;\n              case \"Document submitted\":\n                support_item.application_submitted = \"Yes\"\n                support_item.status = \"Under process\"\n                support_item.date_of_application = latestFollowup.date_of_application || support_item.date_of_application\n                support_item.mode_of_application = latestFollowup.mode_of_application || support_item.mode_of_application\n                support_item.reason_of_application = latestFollowup.reason_of_application || support_item.reason_of_application\n                support_item.application_number = latestFollowup.application_number || support_item.application_number\n                support_item.amount_paid = latestFollowup.amount_paid || support_item.amount_paid\n                support_item.paid_by = latestFollowup.paid_by || support_item.paid_by\n                support_item.remarks = latestFollowup.remarks || support_item.remarks\n                break;\n              case \"Completed\":\n                support_item.status = \"Completed\"\n                support_item.date_of_completion = latestFollowup.date_of_completion || support_item.date_of_completion\n                support_item.completion_certificate = latestFollowup.completion_certificate || support_item.completion_certificate\n                support_item.remarks = latestFollowup.remarks || support_item.remarks\n                break;\n              case \"Not reachable\":\n                if (support_item.status != \"Closed\") {\n                  if (latestFollowup.to_close_status) {\n                    support_item.status = latestFollowup.to_close_status\n                  }\n                  // else {\n                  // support_item.status = support_item?.application_submitted == \"Yes\" ? \"Under process\" : \"Open\"\n                  // }\n                }\n                break;\n              default:\n                support_item.status = \"Under process\"\n                break;\n            }\n          }\n        }\n      }\n\n    }\n\n    let open, under_process, form_submitted, rejected, completed, closed;\n    open = under_process = form_submitted = rejected = completed = closed = 0;\n    let total_no_of_support = 0\n    if (frm.selected_doc.scheme_table) {\n      for (item of frm.selected_doc?.scheme_table) {\n        // global_data.push(item)\n        ++total_no_of_support\n        if (item.status === 'Open') {\n          ++open\n        } else if (item.status === 'Under process') {\n          ++under_process\n        } else if (item.status === 'Form submitted') {\n          ++form_submitted\n        } else if (item.status === 'Rejected') {\n          ++rejected\n        } else if (item.status === 'Completed' || item.status === 'Previously availed') {\n          ++completed\n        } else {\n          ++closed\n        }\n      }\n    }\n    let numberic_overall_status = (completed + rejected) + '/' + (completed + rejected + form_submitted + under_process + open)\n    frm.doc.numeric_overall_status = numberic_overall_status;\n    if (total_no_of_support === open) {\n      frm.doc.overall_status = 'Open'\n    } else if (total_no_of_support === completed) {\n      frm.doc.overall_status = 'Completed'\n    } else {\n      if (total_no_of_support === open + under_process + form_submitted) {\n        frm.doc.overall_status = 'Open'\n      } else if (total_no_of_support === completed + closed + rejected) {\n        frm.doc.overall_status = 'Completed'\n      } else {\n        frm.doc.overall_status = 'Partially completed'\n      }\n    }\n\t}\n})",
  "view": "Form"
 }
]